<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>바른 결 - AI 자세 측정</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        :root { --main-green: #556B2F; --bg-dark: #1A1A1A; }
        body { margin: 0; padding: 0; background: var(--bg-dark); font-family: -apple-system, sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 100vh; color: white; }
        
        .header { width: 100%; text-align: center; padding-top: 60px; }
        .header h1 { font-size: 24px; margin: 0 0 10px; }
        
        /* 실제 카메라는 숨김 처리 */
        #input_video { display: none; }
        
        .camera-container { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            position: relative; width: 100%; max-width: 400px; 
        }
        .ai-placeholder { 
            width: 85%; height: 70%; border: 2px dashed rgba(255,255,255,0.3); 
            border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5);
        }
        
        .giraffe-icon { width: 120px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .feedback { 
            position: absolute; bottom: 30px; background: var(--main-green); 
            padding: 12px 24px; border-radius: 30px; font-weight: bold; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #1A1A1A; display:flex; align-items:center; justify-content:center; z-index:100; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">AI 모델 분석 준비 중...</div>

    <div class="header">
        <h1>자세 분석 중</h1>
        <p id="sub-text">정면(측면)을 바라봐 주세요</p>
    </div>

    <video id="input_video"></video>

    <div class="camera-container">
        <div class="ai-placeholder">
            <img src="normal_logo.png" class="giraffe-icon" alt="Giraffe" onerror="this.src='https://img.icons8.com/illustrations/parallax/512/giraffe.png'">
            <p id="status-text" style="color: #888; margin-top: 20px;">어깨와 귀 위치를 찾는 중...</p>
        </div>
        <div id="feedback" class="feedback">카메라를 켜주세요</div>
    </div>

    <div style="margin-bottom: 50px; font-size: 14px; color: #556B2F;">진행률: <span id="progress">0</span>%</div>

    <script>
        const videoElement = document.getElementById('input_video');
        const statusText = document.getElementById('status-text');
        const feedback = document.getElementById('feedback');
        const progressText = document.getElementById('progress');
        const loading = document.getElementById('loading');

        let totalScore = 0;
        let frames = 0;
        let currentProgress = 0;

        // 거북목 분석 로직 (귀와 어깨의 수평 거리 분석)
        function onResults(results) {
            loading.style.display = 'none';
            if (!results.poseLandmarks) {
                feedback.innerText = "사용자를 찾을 수 없습니다.";
                return;
            }

            frames++;
            const landmarks = results.poseLandmarks;
            
            // 7: 왼쪽 귀, 8: 오른쪽 귀, 11: 왼쪽 어깨, 12: 오른쪽 어깨
            const ear = landmarks[7]; 
            const shoulder = landmarks[11];
            
            // 귀와 어깨의 수평 거리 계산 (거북목 지표)
            const neckGap = Math.abs(ear.x - shoulder.x) * 100;
            
            if (neckGap > 15) {
                feedback.innerText = "⚠️ 목이 앞으로 나와있어요!";
                totalScore += 1; // 주의 상태 누적
            } else {
                feedback.innerText = "✅ 아주 좋은 자세입니다!";
                totalScore += 0; // 정상 상태
            }

            // 10초간 데이터 수집 (100% 채우기)
            if (currentProgress < 100) {
                currentProgress += 0.5; // 프레임당 증가율
                progressText.innerText = Math.floor(currentProgress);
            } else {
                finalizeAnalysis();
            }
        }

        function finalizeAnalysis() {
            // 평균 점수 기반 상태 결정
            let finalStatus = 'good';
            const avgScore = totalScore / frames;
            
            if (avgScore > 0.6) finalStatus = 'severe';
            else if (avgScore > 0.3) finalStatus = 'caution';

            const resultData = {
                neckStatus: finalStatus,
                neckAngle: (Math.random() * 5 + 5).toFixed(1), // 실제 계산 로직으로 대체 가능
                loadReduction: (12 - (avgScore * 10)).toFixed(1)
            };

            localStorage.setItem('bareunGyeolReportData', JSON.stringify(resultData));
            location.href = 'custom_exercise.html';
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>
