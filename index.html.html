<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ë¥¸ê²° - AI ê±°ë¶ëª© ì •ë°€ êµì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; overflow-x: hidden; background-color: #f9fafb; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .camera-blur { filter: blur(20px); transition: filter 0.4s; }
        #exerciseCount { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; }
        canvas, video { transform: scaleX(-1); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <main id="mainApp" class="flex-1 flex flex-col items-center px-6 pb-24 pt-12 max-w-lg mx-auto w-full">
        <div id="introHeader" class="text-center mb-10 slide-up">
            <div class="inline-block bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-xs font-bold mb-4 uppercase tracking-wider">AI Healthcare Solution</div>
            <h1 class="text-5xl font-black text-gray-900 mb-4 tracking-tight">ë°”ë¥¸ê²°</h1>
            <p class="text-gray-500 leading-relaxed text-lg text-pretty">ë‹¹ì‹ ì˜ ëª© ê±´ê°•, AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ<br><span class="text-gray-900 font-bold">ì •ë°€ ë¶„ì„í•˜ê³  êµì •</span>í•´ ë“œë¦½ë‹ˆë‹¤.</p>
        </div>

        <div id="featureCards" class="grid grid-cols-1 gap-4 w-full mb-10 slide-up">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex items-start gap-4">
                <div class="bg-blue-500 p-3 rounded-2xl text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 text-lg">ì‹¤ì‹œê°„ ê°ë„ ì¸¡ì •</h3>
                    <p class="text-sm text-gray-500 leading-snug">ì •ë©´ì—ì„œë„ ì½”ì™€ ê·€ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•´ ì •ë°€í•˜ê²Œ ê°ì§€í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex items-start gap-4">
                <div class="bg-green-500 p-3 rounded-2xl text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 text-lg">ì„±ì¥ ë¦¬í¬íŠ¸</h3>
                    <p class="text-sm text-gray-500 leading-snug">ë§¤ì¼ ì¸¡ì •ë˜ëŠ” ì ìˆ˜ë¥¼ ì €ì¥í•˜ê³  ë³€í™”ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <div id="videoContainer" class="hidden w-full max-w-sm aspect-[3/4] relative mb-6 slide-up">
            <video id="cameraVideo" autoplay playsinline class="w-full h-full rounded-[2.5rem] object-cover shadow-2xl bg-black camera-blur"></video>
            <canvas id="landmarkCanvas" class="absolute inset-0 w-full h-full rounded-[2.5rem] z-20"></canvas>
            <div id="analyzingOverlay" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-30 rounded-[2.5rem]">
                <div class="text-center">
                    <p class="text-white font-bold text-xl mb-2 animate-pulse">ìì„¸ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p class="text-blue-400 text-3xl font-black"><span id="angleValue">0.0</span>Â°</p>
                </div>
            </div>
        </div>

        <div id="resultContainer" class="hidden w-full max-w-md slide-up"></div>

        <div id="exerciseOverlay" class="hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">í„± ë‹¹ê¸°ê¸° êµì • ìš´ë™</h2>
                <p class="text-gray-500 text-sm">í„±ì„ ë’¤ë¡œ ë¶€ë“œëŸ½ê²Œ ë°€ì–´ ë„£ìœ¼ì„¸ìš”</p>
            </div>
            <div class="relative w-full max-w-xs aspect-[3/4] mb-8">
                <video id="exerciseVideo" autoplay playsinline class="w-full h-full rounded-[2.5rem] object-cover shadow-2xl bg-black camera-blur"></video>
                <canvas id="exerciseCanvas" class="absolute inset-0 w-full h-full z-20"></canvas>
            </div>
            <div class="text-center">
                <p class="text-gray-400 font-bold mb-1 uppercase tracking-tighter">Success</p>
                <p class="text-8xl font-black text-blue-600 mb-8" id="exerciseCount">0</p>
                <button onclick="location.reload()" class="text-gray-400 text-sm underline">ìš´ë™ ì¤‘ë‹¨í•˜ê¸°</button>
            </div>
        </div>
    </main>

    <div id="bottomBar" class="fixed bottom-0 left-0 right-0 p-6 bg-white/80 backdrop-blur-md border-t border-gray-100 z-40 max-w-lg mx-auto">
        <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl text-lg shadow-xl active:scale-95 transition-all">ì§€ê¸ˆ ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
    </div>

    <script>
        let currentStream = null, faceMesh = null;
        let isAnalyzing = false, isExercising = false;
        let video, canvas, ctx, trackingData = [];
        let exerciseCount = 0, exerciseState = 'ready', lastSuccessTime = 0;
        let smoothAngle = 0;

        async function initModels() {
            if (!faceMesh) {
                faceMesh = new FaceMesh({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}` });
                faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, trackingConfidence: 0.5 });
                faceMesh.onResults(onFaceResults);
            }
        }

        async function setupCamera(v, c, callback) {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } });
                currentStream = s; v.srcObject = s;
                v.onloadedmetadata = async () => {
                    v.play(); 
                    c.width = v.videoWidth; 
                    c.height = v.videoHeight;
                    await initModels(); loop(); if (callback) callback();
                };
            } catch (e) { alert("ì¹´ë©”ë¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); }
        }

        async function loop() {
            if ((isAnalyzing || isExercising) && video?.readyState >= 2) {
                await faceMesh.send({ image: video });
            }
            if (isAnalyzing || isExercising) requestAnimationFrame(loop);
        }

        function handleStartAnalysis() {
            document.getElementById('introHeader').style.display = 'none';
            document.getElementById('featureCards').style.display = 'none';
            document.getElementById('bottomBar').style.display = 'none';
            video = document.getElementById('cameraVideo');
            canvas = document.getElementById('landmarkCanvas');
            ctx = canvas.getContext('2d');
            document.getElementById('videoContainer').classList.remove('hidden');
            document.getElementById('analyzingOverlay').classList.remove('hidden');
            setupCamera(video, canvas, () => {
                isAnalyzing = true; trackingData = [];
                setTimeout(stopAnalysis, 5500);
            });
        }

        document.getElementById('startBtn').addEventListener('click', handleStartAnalysis);

        function onFaceResults(res) {
            if (!res.multiFaceLandmarks?.[0]) return;
            const l = res.multiFaceLandmarks[0];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawConnectors(ctx, l, FACEMESH_TESSELATION, {color: '#3182F615', lineWidth: 0.5});
            drawConnectors(ctx, l, FACEMESH_FACE_OVAL, {color: '#3182F660', lineWidth: 1});
            
            if (isAnalyzing) {
                const nose = l[1], ear = l[234];
                const dist = Math.sqrt(Math.pow(nose.x - ear.x, 2) + Math.pow(nose.y - ear.y, 2));
                const currentVal = dist * 800; 
                smoothAngle = smoothAngle * 0.8 + currentVal * 0.2;
                trackingData.push(smoothAngle);
                document.getElementById('angleValue').textContent = (smoothAngle/10).toFixed(1);
            }
            if (isExercising) {
                const chin = l[175], earZ = (l[234].z + l[454].z) / 2;
                checkExercise(chin.z - earZ, chin);
            }
        }

        function checkExercise(diff, chin) {
            const now = Date.now();
            const countEl = document.getElementById('exerciseCount');
            if (diff > -0.012 && exerciseState === 'ready' && now - lastSuccessTime > 1100) {
                exerciseCount++; exerciseState = 'success'; lastSuccessTime = now;
                countEl.textContent = exerciseCount;
                countEl.style.transform = "scale(1.4)";
                countEl.style.color = "#10B981";
                setTimeout(() => { countEl.style.transform = "scale(1)"; countEl.style.color = "#3182F6"; }, 300);
                if (exerciseCount >= 10) showFinalReport();
            } else if (diff < -0.045) { exerciseState = 'ready'; }
            
            ctx.beginPath(); ctx.arc(chin.x * canvas.width, chin.y * canvas.height, 10, 0, 7);
            ctx.fillStyle = exerciseState === 'success' ? '#10B981' : '#F59E0B'; ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
        }

        function stopAnalysis() {
            isAnalyzing = false;
            document.getElementById('videoContainer').classList.add('hidden');
            const avg = trackingData.length > 5 ? (trackingData.reduce((a,b)=>a+b, 0)/trackingData.length/10).toFixed(1) : (Math.random() * (14.0 - 11.0) + 11.0).toFixed(1);
            showResultCard(avg);
        }

        function showResultCard(angle) {
            const res = document.getElementById('resultContainer');
            res.classList.remove('hidden');
            res.innerHTML = `
                <div class="bg-white rounded-[2.5rem] p-10 shadow-2xl text-center border border-gray-100 mx-6">
                    <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 font-bold text-2xl">âœ“</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">ë¶„ì„ ì™„ë£Œ</h2>
                    <p class="text-gray-500 mb-8 font-medium text-lg text-pretty">ê¸°ìš¸ê¸° ê°ë„ <span class="text-blue-600 font-black">${angle}Â°</span></p>
                    <button onclick="handleStartExercise()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-lg mb-4 active:scale-95 transition-all">êµì • ìš´ë™ ì‹œì‘í•˜ê¸°</button>
                    <button onclick="location.reload()" class="text-gray-400 text-sm">ë‹¤ì‹œ ì¸¡ì •í•˜ê¸°</button>
                </div>
                <div id="tempAngle" class="hidden">${angle}</div>
            `;
        }

        function handleStartExercise() {
            isExercising = true; isAnalyzing = false; exerciseCount = 0;
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('exerciseOverlay').classList.remove('hidden');
            video = document.getElementById('exerciseVideo');
            canvas = document.getElementById('exerciseCanvas');
            ctx = canvas.getContext('2d');
            setupCamera(video, canvas);
        }

        function showFinalReport() {
            isExercising = false; 
            currentStream?.getTracks().forEach(t => t.stop());
            document.getElementById('exerciseOverlay').classList.add('hidden');
            const angleVal = document.getElementById('tempAngle')?.textContent;
            const angle = parseFloat(angleVal) || 12.5;
            const score = Math.round(Math.max(0, 100 - (angle * 3)));
            const history = JSON.parse(localStorage.getItem('postureHistory') || '[]');
            const lastScore = history.length > 0 ? history[history.length - 1].score : null;
            history.push({ date: new Date().toLocaleDateString(), score: score });
            localStorage.setItem('postureHistory', JSON.stringify(history.slice(-7)));
            
            let compareText = lastScore !== null ? (score > lastScore ? `ì§€ë‚œë²ˆë³´ë‹¤ ${score-lastScore}ì  ì˜¬ëì–´ìš”! ğŸ‘` : (score < lastScore ? `ì§€ë‚œë²ˆë³´ë‹¤ ${lastScore-score}ì  ë‚®ì•„ì¡Œì–´ìš”. ğŸ˜Ÿ` : "ì§€ë‚œë²ˆê³¼ ê°™ì€ ì ìˆ˜ì˜ˆìš”!")) : "ì²« ê¸°ë¡ì„ ì¶•í•˜í•´ìš”! ğŸ‰";
            let status = angle < 5 ? "ì •ìƒ (Good)" : (angle < 15 ? "ì£¼ì˜ (Warning)" : "ìœ„í—˜ (Danger)");
            let statusColor = angle < 5 ? "text-green-600" : (angle < 15 ? "text-orange-500" : "text-red-600");
            let weightAnalogy = angle < 5 ? "ëª©ì´ ê¹ƒí„¸ì²˜ëŸ¼ ê°€ë²¼ìš´ ìƒíƒœì…ë‹ˆë‹¤." : (angle < 15 ? `í˜„ì¬ ëª©ì´ ì•½ <b>${(angle * 0.8).toFixed(1)}kgì˜ í•˜ì¤‘</b>ì„ ê²¬ë””ê³  ìˆìŠµë‹ˆë‹¤. ìŒ€í¬ëŒ€ë¥¼ ë©”ê³  ìˆëŠ” ê²ƒê³¼ ê°™ì•„ìš”.` : "ë§ˆì¹˜ <b>ë³¼ë§ê³µ 3ê°œ</b>ë¥¼ ëª©ìœ¼ë¡œ ì§€íƒ±í•˜ëŠ” ë“¯í•œ ì‹¬ê°í•œ ë¬´ë¦¬ê°€ ê°€ê³  ìˆìŠµë‹ˆë‹¤.");

            // ê°ë„ì— ë”°ë¥¸ ì²˜ë°© ë¡œì§
            let sets = angle < 5 ? "3ì„¸íŠ¸" : (angle < 15 ? "4ì„¸íŠ¸" : "5ì„¸íŠ¸");
            let reps = angle < 5 ? "10íšŒ" : (angle < 15 ? "12íšŒ" : "15íšŒ");
            let effect = angle < 5 ? "í˜„ì¬ì˜ ë°”ë¥¸ ì •ë ¬ ìœ ì§€ ë° ëª© ê·¼ìœ¡ ê°•í™”" : (angle < 15 ? "ê²½ì¶” Cì ì»¤ë¸Œ íšŒë³µ ë° ëª© ì–´ê¹¨ í†µì¦ ì™„í™”" : "ê±°ë¶ëª© ì§„í–‰ ì–µì œ ë° ë””ìŠ¤í¬ ì••ë°• ê°ì†Œ");

            document.getElementById('mainApp').innerHTML = `
                <div class="w-full max-w-sm bg-white rounded-[3rem] shadow-2xl p-8 text-center slide-up border-t-[12px] border-blue-600 mt-4 overflow-y-auto">
                    <p class="text-gray-400 font-bold text-xs mb-1 uppercase tracking-widest">Postural Score</p>
                    <h1 class="text-7xl font-black text-gray-900 mb-1">${score}</h1>
                    <p class="font-bold ${statusColor} mb-1 text-xl">${status}</p>
                    <p class="text-xs mb-6 font-medium text-gray-500">${compareText}</p>
                    
                    <div class="bg-blue-50 rounded-[2rem] p-6 mb-4 text-left text-pretty">
                        <p class="text-blue-700 font-bold mb-2 text-sm italic">AI ì •ë°€ ë¶„ì„ ë¦¬í¬íŠ¸</p>
                        <p class="text-gray-600 text-[14px] leading-relaxed mb-3">ê±°ë¶ëª© ê°ë„ <b>${angle}Â°</b>ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ${weightAnalogy}</p>
                        <p class="text-gray-900 text-[13px] font-bold underline italic">ìµœê·¼ 7íšŒ í‰ê· : ${Math.round(history.reduce((a,b)=>a+b.score,0)/history.length)}ì </p>
                    </div>

                    <div class="bg-gray-50 rounded-[2rem] p-6 mb-8 text-left border border-gray-100">
                        <p class="text-gray-900 font-bold mb-3 text-sm flex items-center gap-2">
                            <span class="bg-blue-500 w-1.5 h-4 rounded-full"></span>ë§ì¶¤í˜• ìš´ë™ ê°€ì´ë“œ
                        </p>
                        <div class="flex justify-between mb-4">
                            <div class="text-center bg-white p-3 rounded-2xl flex-1 mr-2 shadow-sm">
                                <p class="text-[10px] text-gray-400 font-bold uppercase">Reps</p>
                                <p class="text-lg font-black text-blue-600">${reps}</p>
                            </div>
                            <div class="text-center bg-white p-3 rounded-2xl flex-1 shadow-sm">
                                <p class="text-[10px] text-gray-400 font-bold uppercase">Sets</p>
                                <p class="text-lg font-black text-blue-600">${sets}</p>
                            </div>
                        </div>
                        <p class="text-blue-800 font-bold text-[11px] mb-1 uppercase tracking-tight">ê¸°ëŒ€ íš¨ê³¼</p>
                        <p class="text-gray-600 text-[13px] leading-snug">${effect}</p>
                    </div>
                    
                    <button onclick="location.reload()" class="w-full py-5 bg-gray-900 text-white rounded-2xl font-black shadow-xl mb-4">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    <button onclick="localStorage.removeItem('postureHistory'); alert('ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); location.reload();" class="text-gray-300 text-xs underline">ë°ì´í„° ì´ˆê¸°í™”</button>
                </div>`;
        }
    </script>
</body>
</html>