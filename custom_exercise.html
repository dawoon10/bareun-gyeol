<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ë§ì¶¤ ìš´ë™ - ë°”ë¥¸ ê²°</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        :root { --main-green: #556B2F; --bg-beige: #F9F9F7; }
        body { margin: 0; background: var(--bg-beige); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; padding: 40px 20px; box-sizing: border-box; overflow: hidden; }
        #input_video { display: none; }
        
        .header { text-align: center; margin-bottom: 20px; z-index: 2; }
        .status-badge { background: #E8EDE0; color: var(--main-green); padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 13px; display: inline-block; margin-bottom: 10px; }
        .ex-title { font-size: 24px; font-weight: bold; color: #333; margin: 0; }
        
        .visual-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; width: 100%; }
        
        /* ê¸°ë¦° ì´ë¯¸ì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° íšŒì „ ì¤‘ì‹¬ì¶• ì„¤ì • */
        .giraffe-guide { 
            width: 200px; 
            transition: all 0.5s; 
            transform-origin: bottom center; /* ëª© ì•„ë˜ìª½ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì›€ì§ì´ê²Œ ì„¤ì • */
        }

        /* --- CSS ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ --- */
        
        /* 1. ì •ìƒ(Good): ì¢Œìš° ê¹Œë”±ê¹Œë”± */
        @keyframes tiltAnim {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); } /* ì™¼ìª½ */
            75% { transform: rotate(10deg); }  /* ì˜¤ë¥¸ìª½ */
        }
        .anim-tilt { animation: tiltAnim 3s ease-in-out infinite; }

        /* 2. ì£¼ì˜(Caution): ì•ë’¤ë¡œ ì­‰ì­‰ (í™•ëŒ€/ì¶•ì†Œë¡œ í‘œí˜„) */
        @keyframes stretchAnim {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.1) translateY(-15px); } /* ì•ìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ëŠë‚Œ */
        }
        .anim-stretch { animation: stretchAnim 2.5s ease-in-out infinite; }

        /* 3. ì‹¬ê°(Severe): ë’¤ë¡œ ì –íˆê¸° (í•˜ëŠ˜ ë³´ê¸°) */
        @keyframes lookUpAnim {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-20deg) translateY(-10px); } /* ë’¤ë¡œ ì –íˆëŠ” ëŠë‚Œ */
        }
        .anim-lookup { animation: lookUpAnim 3s ease-in-out infinite; }
        
        /* ------------------------- */

        .method-card { background: white; width: 100%; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 30px; text-align: center; z-index: 2; }
        .method-card strong { color: var(--main-green); display: block; margin-bottom: 8px; font-size: 17px; }
        .method-card p { margin: 0; font-size: 15px; color: #666; line-height: 1.5; }

        .counter { font-size: 70px; font-weight: 900; color: var(--main-green); margin-bottom: 10px; position: absolute; bottom: 20%; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); }
        .target-count { color: #AAA; font-weight: bold; position: absolute; bottom: 15%; }
    </style>
</head>
<body>
    <video id="input_video"></video>
    
    <div class="header">
        <div id="statusBadge" class="status-badge">ë¶„ì„ ê²°ê³¼ ë°˜ì˜ ì¤‘...</div>
        <h1 id="exTitle" class="ex-title">ë§ì¶¤ ìŠ¤íŠ¸ë ˆì¹­</h1>
    </div>

    <div class="visual-box">
        <img id="giraffeImg" src="giraffe-character.png" class="giraffe-guide" alt="ìš´ë™í•˜ëŠ” ê¸°ë¦°" onerror="this.src='https://img.icons8.com/illustrations/parallax/512/giraffe.png'">
        <div id="counter" class="counter">0</div>
        <div id="targetCount" class="target-count">/ 0íšŒ</div>
    </div>

    <div class="method-card">
        <strong id="methodName">ìš´ë™ ë°©ë²•</strong>
        <p id="methodDesc">ê¸°ë¦°ì˜ ì›€ì§ì„ì„ ë”°ë¼í•´ë³´ì„¸ìš”.</p>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê¸°ë³¸ê°’ì„ 'caution'ì´ë‚˜ 'severe'ë¡œ ë°”ê¿”ì„œ ì• ë‹ˆë©”ì´ì…˜ì„ í™•ì¸í•´ë³´ì„¸ìš”.
        const data = JSON.parse(localStorage.getItem('bareunGyeolReportData') || '{"neckStatus":"good"}');
        
        // ìš´ë™ ì¢…ë¥˜ë³„ ì •ë³´ ë° ì ìš©í•  ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì •ì˜
        const exerciseLibrary = {
            good: {
                badge: "âœ¨ ê²°ì´ ë§‘ì€ ìƒíƒœ",
                title: "ê¸°ë¦° ê³ ê°œ ê¹Œë”± ìš´ë™",
                method: "ì¢Œìš° ìŠ¤íŠ¸ë ˆì¹­",
                desc: "ê¸°ë¦°ì²˜ëŸ¼ ê³ ê°œë¥¼ ì¢Œìš°ë¡œ ì²œì²œíˆ ê¸°ìš¸ì—¬ ì˜† ëª©ì„ ëŠ˜ë ¤ì£¼ì„¸ìš”.",
                target: 5,
                animClass: 'anim-tilt' // ì¢Œìš° ê¹Œë”± ì• ë‹ˆë©”ì´ì…˜ ì ìš©
            },
            caution: {
                badge: "ğŸŒ¿ ê²°ì´ ì¡°ê¸ˆ íë ¤ì§„ ìƒíƒœ",
                title: "ê¸°ë¦° ëª© ì­‰ì­‰ ìš´ë™",
                method: "ì „í›„ ìŠ¤íŠ¸ë ˆì¹­",
                desc: "í„±ì„ ì•ìœ¼ë¡œ ì­‰ ë‚´ë°€ì—ˆë‹¤ê°€, ë‹¤ì‹œ ëª© ë’¤ë¡œ ë°”ì§ ë‹¹ê²¨ì£¼ì„¸ìš”.",
                target: 8,
                animClass: 'anim-stretch' // ì•ë’¤ ì­‰ì­‰ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
            },
            severe: {
                badge: "ğŸ”‹ ê²° ì—ë„ˆì§€ê°€ í•„ìš”í•œ ìƒíƒœ",
                title: "ê¸°ë¦° í•˜ëŠ˜ ë³´ê¸° ìš´ë™",
                method: "ì‹ ì „ ìš´ë™ (ì –íˆê¸°)",
                desc: "ê°€ìŠ´ì„ í´ê³  ê³ ê°œë¥¼ ì²œì²œíˆ ë’¤ë¡œ ì –í˜€ í•˜ëŠ˜ì„ ë°”ë¼ë³´ì„¸ìš”.",
                target: 12,
                animClass: 'anim-lookup' // ë’¤ë¡œ ì –íˆê¸° ì• ë‹ˆë©”ì´ì…˜ ì ìš©
            }
        };

        const config = exerciseLibrary[data.neckStatus] || exerciseLibrary.good;
        
        // UI ë° ì• ë‹ˆë©”ì´ì…˜ ì ìš©
        document.getElementById('statusBadge').innerText = config.badge;
        document.getElementById('exTitle').innerText = config.title;
        document.getElementById('methodName').innerText = `[${config.method}]`;
        document.getElementById('methodDesc').innerText = config.desc;
        document.getElementById('targetCount').innerText = `/ ${config.target}íšŒ ì™„ë£Œí•˜ê¸°`;
        
        // **í•µì‹¬: ìƒíƒœì— ë§ëŠ” ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ë¥¼ ê¸°ë¦° ì´ë¯¸ì§€ì— ì¶”ê°€**
        const giraffeImg = document.getElementById('giraffeImg');
        // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±° í›„ ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€
        giraffeImg.classList.remove('anim-tilt', 'anim-stretch', 'anim-lookup');
        giraffeImg.classList.add(config.animClass);


        // --- AI ì¹´ìš´íŒ… ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        let count = 0;
        let isMoving = false;

        function onResults(results) {
            if (!results.poseLandmarks) return;
            const nose = results.poseLandmarks[0];

            // ì‹¤ì œ ì›€ì§ì„ ê°ì§€ ë¡œì§ (ìƒíƒœë³„ë¡œ ë‹¤ë¥¸ ë™ì‘ ê¸°ì¤€ ì ìš© ê°€ëŠ¥)
            // ì—¬ê¸°ì„œëŠ” ê³µí†µì ìœ¼ë¡œ ê³ ê°œë¥¼ ìˆ™ì˜€ë‹¤ ë“œëŠ” ë™ì‘ì„ ê°ì§€í•©ë‹ˆë‹¤.
            if (!isMoving && nose.y > 0.55) { 
                isMoving = true;
            } 
            if (isMoving && nose.y < 0.45) {
                isMoving = false;
                count++;
                document.getElementById('counter').innerText = count;

                if (count >= config.target) {
                    location.href = 'report.html';
                }
            }
        }

        const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
        pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>
