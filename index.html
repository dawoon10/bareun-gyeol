<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바른결 - AI 거북목 교정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        
        /* 귀여운 캐릭터 애니메이션 */
        .character-box {
            position: relative; width: 120px; height: 150px; margin: 0 auto;
        }
        .body { width: 60px; height: 60px; background: #3b82f6; border-radius: 20px 20px 10px 10px; position: absolute; bottom: 10px; left: 30px; }
        .head { 
            width: 50px; height: 50px; background: #ffdbac; border-radius: 50%; 
            position: absolute; bottom: 70px; left: 35px;
            animation: neckMove 3s infinite ease-in-out;
        }
        .face { position: relative; width: 100%; height: 100%; }
        .eye { width: 6px; height: 6px; background: #333; border-radius: 50%; position: absolute; top: 20px; }
        .eye.left { left: 10px; } .eye.right { right: 10px; }
        .mouth { width: 15px; height: 8px; border: 2px solid #333; border-top: 0; border-radius: 0 0 10px 10px; position: absolute; bottom: 10px; left: 17px; }

        @keyframes neckMove {
            0%, 100% { transform: translate(0, 0); box-shadow: 0 0 0 0 rgba(0,0,0,0); } /* 바른 자세 */
            50% { transform: translate(30px, 10px) rotate(15deg); } /* 거북목 자세 */
        }
        
        .guide-text { animation: textChange 3s infinite; }
        @keyframes textChange {
            0%, 100% { content: "바른 자세 (턱을 당기세요)"; color: #10b981; }
            50% { content: "나쁜 자세 (거북목 상태)"; color: #ef4444; }
        }
    </style>
</head>
<body class="flex flex-col items-center p-5">

    <div id="start-screen" class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 text-center mt-10">
        <h1 class="text-3xl font-bold text-blue-600 mb-2">바른결</h1>
        <p class="text-gray-500 mb-8">우리 가족 거북목 탈출 프로젝트</p>

        <div class="character-box mb-6">
            <div class="body"></div>
            <div class="head">
                <div class="face">
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                    <div class="mouth"></div>
                </div>
            </div>
        </div>
        
        <div id="status-label" class="text-lg font-bold mb-8 h-8">
            <span class="guide-msg text-blue-500">화면처럼 턱을 당겨보세요!</span>
        </div>

        <button onclick="startApp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl text-xl transition-all shadow-lg transform active:scale-95">
            운동 시작하기
        </button>
        <p class="mt-4 text-xs text-gray-400">카메라 권한 허용이 필요합니다.</p>
    </div>

    <div id="main-app" class="hidden w-full max-w-md text-center">
        <div class="relative rounded-3xl overflow-hidden shadow-2xl bg-black mb-6">
            <video id="video" class="w-full h-auto transform -scale-x-1" autoplay playsinline></video>
            <canvas id="output" class="absolute top-0 left-0 w-full h-full transform -scale-x-1"></canvas>
            <div id="alert-box" class="absolute top-5 left-1/2 -translate-x-1/2 px-6 py-2 rounded-full font-bold text-white hidden"></div>
        </div>
        
        <div class="bg-white rounded-3xl p-6 shadow-lg">
            <div class="text-sm text-gray-500 mb-1">현재 거북목 각도</div>
            <div id="angle-display" class="text-5xl font-black text-blue-600 mb-2">0°</div>
            <p id="feedback" class="text-gray-600 font-medium">카메라를 분석 중입니다...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-net"></script>

    <script>
        const guideMsg = document.querySelector('.guide-msg');
        let msgToggle = true;

        // 가이드 문구 주기적 변경
        setInterval(() => {
            guideMsg.innerText = msgToggle ? "나쁜 자세 (고개가 앞으로!)" : "바른 자세 (턱을 당기세요!)";
            guideMsg.style.color = msgToggle ? "#ef4444" : "#10b981";
            msgToggle = !msgToggle;
        }, 1500);

        async function startApp() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            setupCamera();
        }

        async function setupCamera() {
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            const net = await posenet.load();
            detectPose(video, net);
        }

        async function detectPose(video, net) {
            const canvas = document.getElementById('output');
            const ctx = canvas.getContext('2d');

            async function frame() {
                const pose = await net.estimateSinglePose(video);
                if (pose) {
                    analyzeNeck(pose);
                }
                requestAnimationFrame(frame);
            }
            frame();
        }

        function analyzeNeck(pose) {
            const eye = pose.keypoints[1].position; // 왼쪽 눈
            const shoulder = pose.keypoints[5].position; // 왼쪽 어깨
            
            // 단순화된 거북목 계산법 (눈과 어깨의 수평 거리)
            const diffX = Math.abs(eye.x - shoulder.x);
            const angle = Math.round(diffX / 2); // 임의 보정값
            
            document.getElementById('angle-display').innerText = `${angle}°`;
            
            const alertBox = document.getElementById('alert-box');
            const feedback = document.getElementById('feedback');

            if (angle > 45) {
                alertBox.innerText = "⚠️ 고개를 당기세요!";
                alertBox.className = "absolute top-5 left-1/2 -translate-x-1/2 px-6 py-2 rounded-full font-bold text-white bg-red-500 animate-bounce block";
                feedback.innerText = "어깨보다 고개가 너무 앞으로 나왔어요!";
            } else {
                alertBox.className = "hidden";
                feedback.innerText = "좋습니다! 아주 바른 자세예요.";
            }
        }
    </script>
</body>
</html>
