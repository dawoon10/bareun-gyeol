<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바른결 - AI 거북목 교정</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f2f4f6; }
        .toss-card { background: white; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .btn-toss { background-color: #3182f6; color: white; border-radius: 12px; transition: all 0.2s; }
        .btn-toss:active { transform: scale(0.98); background-color: #1b64da; }
        /* 가이드 모달 */
        #exercise-guide {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; z-index: 100;
            justify-content: center; align-items: center; padding: 20px;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">

    <div id="app-container" class="w-full max-w-md p-5 space-y-4">
        <header class="py-6 text-left">
            <h1 class="text-2xl font-bold text-gray-900">거북목 점수 확인하기</h1>
            <p class="text-gray-500">카메라를 보고 잠시만 기다려주세요.</p>
        </header>

        <div class="toss-card relative overflow-hidden aspect-[3/4] bg-black">
            <video id="video" class="w-full h-full object-cover -scale-x-1" autoplay playsinline></video>
            <canvas id="output" class="absolute top-0 left-0 w-full h-full -scale-x-1"></canvas>
            
            <div class="absolute bottom-6 left-6 right-6 p-4 bg-white/90 backdrop-blur rounded-2xl flex justify-between items-center">
                <div>
                    <span class="text-sm text-gray-500 block">거북목 각도</span>
                    <span id="angle-display" class="text-3xl font-bold text-blue-600">0°</span>
                </div>
                <div id="status-badge" class="px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-600">분석 중</div>
            </div>
        </div>

        <button id="guide-btn" onclick="showGuide()" class="hidden w-full btn-toss py-4 text-lg font-bold shadow-lg">
            운동 방법 확인하기
        </button>
    </div>

    <div id="exercise-guide">
        <div class="toss-card w-full max-w-sm p-8 flex flex-col items-center">
            <div id="lottie-container" class="w-48 h-48 mb-6"></div> <h2 class="text-xl font-bold mb-2">턱 당기기 운동</h2>
            <p class="text-gray-600 text-center mb-8">
                정수리를 위로 당기듯 허리를 펴고<br>
                <span class="text-blue-600 font-bold">턱을 목 쪽으로 꾹-</span> 당겨주세요.
            </p>
            <button onclick="closeGuide()" class="w-full btn-toss py-4 font-bold text-lg">
                확인했습니다
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-net"></script>

    <script>
        let isAnalysing = true;

        // 1. 애니메이션 로드 (Lottie)
        const animation = lottie.loadAnimation({
            container: document.getElementById('lottie-container'),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://assets5.lottiefiles.com/packages/lf20_at6p7rqi.json' // 거북목 교정 유사 애니메이션
        });

        async function setupCamera() {
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            const net = await posenet.load();
            detectPose(video, net);
        }

        async function detectPose(video, net) {
            async function frame() {
                const pose = await net.estimateSinglePose(video);
                if (pose && isAnalysing) {
                    const eye = pose.keypoints[1].position;
                    const shoulder = pose.keypoints[5].position;
                    const diffX = Math.abs(eye.x - shoulder.x);
                    const angle = Math.round(diffX / 2);

                    document.getElementById('angle-display').innerText = `${angle}°`;

                    // 각도가 높을 때 버튼 노출
                    if (angle > 35) {
                        document.getElementById('status-badge').innerText = "위험";
                        document.getElementById('status-badge').className = "px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-600";
                        document.getElementById('guide-btn').classList.remove('hidden');
                    }
                }
                requestAnimationFrame(frame);
            }
            frame();
        }

        function showGuide() {
            document.getElementById('exercise-guide').style.display = 'flex';
        }

        function closeGuide() {
            document.getElementById('exercise-guide').style.display = 'none';
        }

        setupCamera();
    </script>
</body>
</html>
